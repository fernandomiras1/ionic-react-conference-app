# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  before_all do
    setup_circle_ci if ENV['CI']
  end

  desc "Generate new localized screenshots"
  lane :screenshots do
    capture_screenshots(workspace: "App.xcworkspace", scheme: "App")
  end

  desc "Build app for development"
  lane :build do
    # Ensure we have the latest provisioning profiles
    match(
      type: "development",
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
    
    # Build the app
    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      export_method: "development"
    )
  end

  desc "Build and upload to TestFlight for Beta Testing"
  lane :beta do
    # Increment build number
    increment_build_number(xcodeproj: "App.xcodeproj")
    
    # Ensure we have the correct provisioning profiles
    match(
      type: "appstore",
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
    
    # Build the app
    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      export_method: "app-store"
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      notify_external_testers: false,
      apple_id: ENV['FASTLANE_APPLE_ID'],
      team_id: ENV['FASTLANE_TEAM_ID'],
      itc_team_id: ENV['FASTLANE_ITC_TEAM_ID']
    )
    
    # Send notification to Slack (optional)
    if ENV['SLACK_URL']
      slack(
        slack_url: ENV['SLACK_URL'],
        message: "Successfully uploaded a new beta build to TestFlight! ðŸš€",
        channel: "#releases"
      )
    end
  end

  desc "Deploy a new version to the App Store"
  lane :release do
    # Ensure we have the correct provisioning profiles
    match(
      type: "appstore",
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
    
    # Build the app
    gym(
      scheme: "App",
      workspace: "App.xcworkspace",
      export_method: "app-store"
    )
    
    # Upload to App Store
    upload_to_app_store(
      force: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: false,
      apple_id: ENV['FASTLANE_APPLE_ID'],
      team_id: ENV['FASTLANE_TEAM_ID'],
      itc_team_id: ENV['FASTLANE_ITC_TEAM_ID']
    )
    
    # Send notification (optional)
    if ENV['SLACK_URL']
      slack(
        slack_url: ENV['SLACK_URL'],
        message: "Successfully uploaded a new version to App Store! ðŸŽ‰",
        channel: "#releases"
      )
    end
  end

  desc "Refresh provisioning profiles"
  lane :refresh_profiles do
    match(
      type: "development", 
      force_for_new_devices: true,
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
    match(
      type: "adhoc", 
      force_for_new_devices: true,
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
    match(
      type: "appstore",
      git_url: ENV['MATCH_GIT_URL'],
      app_identifier: ENV['FASTLANE_APP_IDENTIFIER']
    )
  end

  error do |lane, exception|
    if ENV['SLACK_URL']
      slack(
        slack_url: ENV['SLACK_URL'],
        message: "Something went wrong with the deployment: #{exception}",
        success: false,
        channel: "#releases"
      )
    end
  end
end
